<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product
    Id="*"
    Name="@SLIC3R_APP_KEY@$(var.ReleaseSuffix)"
    Language="1033"
    Version="$(var.InstallerVersion)"
    Manufacturer="Supermerill"
    UpgradeCode="@SLIC3R_GUID@"
  >

    <Package
      InstallerVersion="500"
      Compressed="yes"
      InstallScope="perMachine"
      Description="@SLIC3R_APP_NAME@ - Advanced 3D printing slicer"
      Comments="@SLIC3R_APP_NAME@ installer package"
    />

    <!-- 1. SEARCH: Read from the same registry key you write below -->
    <Property Id="INSTALLFOLDER">
      <RegistrySearch Id="FindInstallDir"
        Root="HKLM"
        Key="Software\@SLIC3R_APP_KEY@"
        Name="InstallDir"
        Type="raw" />
    </Property>

    <MediaTemplate EmbedCab="yes" />
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." AllowSameVersionUpgrades="yes"/>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="@SLIC3R_APP_KEY@"></Directory>
      </Directory>
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="@SLIC3R_APP_KEY@" />
      </Directory>
      <Directory Id="DesktopFolder" Name="Desktop" />
    </Directory>

    <Feature
      Id="DefaultFeature"
      Title="@SLIC3R_APP_NAME@ Application"
      Level="1"
      Description="The main @SLIC3R_APP_NAME@ application and required files."
    >
      <ComponentGroupRef Id="Package" /> <!-- This is where your main app component is referenced -->
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentRef Id="DesktopShortcut" />
      <ComponentRef Id="CleanupComponent" />
      <ComponentRef Id="RegistryComponent" />
    </Feature>

    <!-- Main application files (update Id and file as needed) -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="RegistryComponent" Guid="*">
        <!-- 2. SAVE: Write install location to registry -->
        <RegistryValue
          Root="HKLM"
          Key="Software\@SLIC3R_APP_KEY@"
          Name="InstallDir"
          Type="string"
          Value="[INSTALLFOLDER]"
          KeyPath="yes" />
      </Component>

      <Component Id="CleanupComponent" Guid="*">
        <RemoveFolder Id="INSTALLFOLDER" On="uninstall" />
        <RegistryKey
          Root="HKLM"
          Key="Software\@SLIC3R_APP_KEY@"
          ForceDeleteOnUninstall="yes"
        />
        <RegistryValue
          Root="HKCU"
          Key="Software\@SLIC3R_APP_KEY@\Cleanup"
          Name="installed"
          Type="integer"
          Value="1"
          KeyPath="yes"
        />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="*">
        <Shortcut
          Id="ApplicationStartMenuShortcut"
          Name="@SLIC3R_APP_KEY@"
          Description="Advanced 3D printing slicer"
          Target="[INSTALLFOLDER]@SLIC3R_APP_CMD@.exe"
          WorkingDirectory="INSTALLFOLDER"
          Icon="@SLIC3R_APP_PROG_ID@Icon.exe"
        />
        <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall" />
        <RegistryValue
          Root="HKCU"
          Key="Software\@SLIC3R_APP_KEY@\StartMenu"
          Name="installed"
          Type="integer"
          Value="1"
          KeyPath="yes"
        />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="*">
        <Shortcut
          Id="ApplicationDesktopShortcut"
          Name="@SLIC3R_APP_KEY@"
          Description="Advanced 3D printing slicer"
          Target="[INSTALLFOLDER]@SLIC3R_APP_CMD@.exe"
          WorkingDirectory="INSTALLFOLDER"
          Icon="@SLIC3R_APP_PROG_ID@Icon.exe"
        />
        <RegistryValue
          Root="HKCU"
          Key="Software\@SLIC3R_APP_KEY@\Desktop"
          Name="installed"
          Type="integer"
          Value="1"
          KeyPath="yes"
        />
      </Component>
    </DirectoryRef>

    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <UIRef Id="WixUI_InstallDir" />

    <WixVariable
      Id="WixUILicenseRtf"
      Value="$(var.SourceDir)\LICENSE.rtf"
      Overridable="yes"
    />

    <Icon
      Id="@SLIC3R_APP_PROG_ID@Icon.exe"
      SourceFile="$(var.SourceDir)\@SLIC3R_APP_CMD@.exe"
    />
    <Property Id="ARPPRODUCTICON" Value="@SLIC3R_APP_PROG_ID@Icon.exe" />
  </Product>
</Wix>